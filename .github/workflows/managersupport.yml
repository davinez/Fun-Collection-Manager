name: Manager Support API Build

on:
  push:
    paths:
      - 'src/ManagerSupport/**'
    branches:    
      - main
      - release/*

  pull_request:
    paths:
      - 'src/ManagerSupport/**'
    branches:    
      - main
      - release/*
  
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  GITHUB_USERNAME: ${{ github.repository_owner }}
  IMAGE_NAME: manager-support-api
  BUILD_CONFIGURATION: Release

jobs:
 build-and-push-manager-image:
    runs-on: ubuntu-latest
    defaults:
          run:
            working-directory: './src/ManagerSupport'
    permissions:
      contents: read
      packages: write

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.REGISTRY_TOKEN }}       

      - name: Add SHORT_SHA env property with commit short sha
        run: echo "SHORT_SHA=`echo ${{ github.sha }} | cut -c1-8`" >> $GITHUB_ENV

      - name: 'Build, tag, and push image to GitHub Container Registry (Packages)'
        run: |
          docker build . \
            --tag ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${SHORT_SHA} \
            -f Dockerfile 
          docker push ${{ env.REGISTRY }}/${{ env.GITHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${SHORT_SHA}

 # Id of the job (random string)
 azure-deploy:
    runs-on: ubuntu-latest
    defaults:
        run:
          working-directory: './'

    steps:  

    - name: 'Login to Azure'
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Build and deploy the container app
    - name: Build and deploy Container App
      uses: azure/container-apps-deploy-action@v0
      with:
        imageToDeploy: ghcr.io/davinez/manager-api:latest
        acrName: ghcr.io
        acrUsername: ${{ secrets.REGISTRY_USERNAME }}
        acrPassword: ${{ secrets.REGISTRY_PASSWORD }}     